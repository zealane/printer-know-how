# Linux下的打印扫描驱动新架构介绍

## CUPS架构简介

过去22年，CUPS从1.0版本发布开始，使用的主要是同一套架构：

- PostScript 作为Unix下打印机的标准任务格式
- 打印机的能力通过PPD（Postscript Printer Description）文件来描述
- PPD文件是一个静态的文本文件，描述所有的用户可设置的选项，资源（纸盒、纸张尺寸、分辨率、打印质量、色彩，...）
- 为了能使非PostScript打印机工作，PPD通过指定一个过滤器（Filter）来生成打印机支持的格式进行扩展
- 过滤器采用GhostScrpt来转换PostScript
- 手动创建队列（=PPD+filter）

## 为什么我们要抛弃PPD？

- Adobe在1984年就已经停止PPD的开发了，所以我们在一个被废弃（但有用）的格式上
- 2006年，我们废弃了PostScript作为打印任务格式，采用PDF来替代。PDF也是现在流行的格式。
- PPD文件只能用枚举或者二值来表示用户可设置的选项。在某些如密码设置、颜色调整上，PPD非常差劲。

## PPD-less的CUPS----all-IPP

- CUPS 3.0.x 不再支持PPD文件
- CUPS Snap 不在允许添加PPD文件和过滤器
- 不仅仅是无驱动IPP打印机（IPP Everywhere，AirPrint,Mopria）被支持
- 无需手动创建CUPS 队列：IPP 打印机被发现后，自动创建临时的队列
- 今后Filter机制仅仅是支持不需要驱动的标准格式如PDF，PWG Raster，Apple Raster，PCLm输出，以后不再需要添加filter了
- 如果是传统的需要驱动的打印机，则采用打印机应用来模仿IPP打印机

## 打印配置工具

### 如何马上工作

- 打印配置工具
  - CUPS 网页管理界面： http://localhost:631/
  - CUPS命令行工具：lpadmin,lpinfo,lpstat
  - system-config-printer-GUI
  - cups-browsed-daemon
  - GNOME 控制中心-打印机模块-GUI

- 工具控制CUPS，运行的cupsd

  - 列出可用的打印机和驱动，创建打印队列

  - 列出队列和任务

  - 修改队列

  - 服务器配置：拥有者或者所有人可取消任务

### 新架构下的打印机管理

- 新架构下的CUPS
  - CUPS Snap
  - 或者CUPS 3.x 或者最新版
- 所有的打印机都是五驱动的IPP打印机，本地化或者打印机应用
- CUPS为每个IPP打印机自动创建虚拟的队列----不再需要手动去创建队列
- CUPS 完全自动化。
- 任务机制
  - 通过GUI按钮打开网页管理页面，配置IPP服务。如果是多功能一体机，我们也可以设置扫描参数
  - 发现无驱打印机
    - 能在本地或者应用商店找到打印应用。不会再去找PPD文件了。我们只要把打印机ID发给打印服务系统，打印服务系统会返回支持该打印机的打印机应用的列表。

### GUI设计

旧架构和新架构的相似之处：

- 主窗口
  - 旧架构：CUPS队列的列表，修改按钮
  - 新架构：IPP设备的列表，网页接口/IPP系统服务的按钮
- 添加打印机窗口
  - 旧架构：打印机和驱动列表，创建CUPS队列
  - 新架构：无驱打印机的列表，安装打印机应用
- 多功能设备、扫描，传真除外
  - 所有的功能都是基于IPP服务，同一个设备的功能列在一起
  - 扫描仪和传真机都跟打印机管理一样

### 已经完成的功能

- IPP服务列表管理GUI（基于GTK+）
- IPP系统服务GUI（基于GTK+）

### 还要完成的功能

- 指导用户配置非无驱打印机（扫描仪）---计划在GSoC 2022完成

- 搜索打印机应用
- 允许打印机应用简易配置打印机
- 三合一功能：列表/管理器+IPP系统服务+添加非无驱打印机

- 完成IPP系统服务的GUI
- GNOME控制中心流---新的“打印和扫描”模块

## 视频链接

https://www.bilibili.com/video/BV16r4y1s7jV/







